{% extends "base.html" %}

{% block content %}
<div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-3">
    <div>
        <h5 class="text-light fw-bold mb-1 text-uppercase small" style="opacity: 0.7;">Admin Panel</h5>
        <h1 class="fw-bold text-white display-6">Manager Dashboard</h1>
    </div>
    <div class="d-flex gap-2">
        <form method="GET" action="{{ url_for('admin_dashboard') }}" class="d-flex">
            <input type="text" name="q" class="form-control-pro form-control-sm" placeholder="Search tickets..." style="border-top-right-radius: 0; border-bottom-right-radius: 0;">
            <button type="submit" class="btn btn-primary btn-sm" style="border-top-left-radius: 0; border-bottom-left-radius: 0;">üîç</button>
        </form>
        <span class="badge bg-primary px-4 py-2 rounded-1 fw-bold d-flex align-items-center">ADMIN</span>
    </div>
</div>

<div class="row mb-5 g-3">
    <div class="col-6 col-md-3">
        <div class="card-pro p-3 text-center h-100">
            <h6 class="text-white small fw-bold" style="opacity: 0.7;">Total</h6>
            <h2 class="text-white fw-bold display-6 mb-0">{{ total }}</h2>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card-pro p-3 text-center h-100">
            <h6 class="text-white small fw-bold" style="opacity: 0.7;">Pending</h6>
            <h2 class="fw-bold display-6 mb-0" style="color: #f59e0b;">{{ pending }}</h2>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card-pro p-3 text-center h-100" style="border: 1px solid rgba(239, 68, 68, 0.5); background: rgba(239, 68, 68, 0.1);">
            <h6 class="text-danger small fw-bold">Priority</h6>
            <h2 class="text-danger fw-bold display-6 mb-0">{{ high_priority }}</h2>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card-pro p-3 text-center h-100">
            <h6 class="text-white small fw-bold" style="opacity: 0.7;">Resolved</h6>
            <h2 class="fw-bold display-6 mb-0" style="color: #10b981;">{{ resolved }}</h2>
        </div>
    </div>
</div>

<div class="row g-4">
    <div class="col-12 col-lg-8">
        <div class="card-pro overflow-hidden h-100">
            <div class="p-4 border-bottom border-secondary" style="border-color: #334155 !important;">
                 <h5 class="text-white fw-bold mb-0">Global Ticket Queue</h5>
            </div>
            <div class="table-responsive">
                <table class="table table-dark table-hover mb-0 align-middle text-nowrap">
                    <thead style="background-color: #0f172a;">
                        <tr>
                            <th class="ps-4 py-3 text-white small" style="opacity: 0.6;">ID</th>
                            <th class="py-3 text-white small" style="opacity: 0.6;">ISSUE</th>
                            <th class="py-3 text-white small" style="opacity: 0.6;">PRIORITY</th>
                            <th class="py-3 text-white small" style="opacity: 0.6;">CATEGORY</th>
                            <th class="py-3 text-end pe-4 text-white small" style="opacity: 0.6;">ACTION</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for complaint in complaints %}
                        <tr style="border-bottom: 1px solid #334155; {% if complaint.priority == 'High' %} background-color: rgba(239, 68, 68, 0.15) !important; {% endif %}">
                            <td class="ps-4 text-white fw-bold">#{{ complaint.id }}</td>
                            <td class="text-white">{{ complaint.subject }}</td>
                            <td>
                                {% if complaint.priority == 'High' %} <span class="badge bg-danger">High</span>
                                {% elif complaint.priority == 'Medium' %} <span class="badge bg-warning text-dark">Medium</span>
                                {% else %} <span class="badge bg-secondary">Low</span> {% endif %}
                            </td>
                            <td><span class="badge border border-secondary text-light">{{ complaint.category }}</span></td>
                            <td class="text-end pe-4">
                                <a href="{{ url_for('ticket_detail', id=complaint.id) }}" class="btn btn-sm btn-primary fw-bold px-3">View</a>
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="5" class="text-center py-5"><p class="text-light mb-0" style="opacity: 0.5;">No tickets found.</p></td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="col-12 col-lg-4">
        <div class="card-pro p-4 h-100 d-flex flex-column align-items-center justify-content-center">
            <h6 class="text-white fw-bold mb-3">Categories Overview</h6>
            <div style="height: 250px; width: 100%;">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctx = document.getElementById('categoryChart').getContext('2d');
    const categoryData = {{ category_counts | tojson }}; // Pass Python dict to JS
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(categoryData),
            datasets: [{
                data: Object.values(categoryData),
                backgroundColor: ['#2563eb', '#f59e0b', '#10b981', '#ef4444', '#8b5cf6'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom', labels: { color: '#cbd5e1' } }
            }
        }
    });
</script>
{% endblock %}